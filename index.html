<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ĐÀI KTTV TRUNG BỘ - LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG</title>

  <!-- ====== Base UI ====== -->
  <style>/* ... (giữ nguyên CSS như anh gửi) ... */
    :root{
      --bg:#f6f8ff; --card:#fff; --txt:#0f172a; --muted:#64748b; --pri:#1d4ed8;
      --ok:#16a34a; --err:#dc2626; --grid:#e2e8f0; --grid-strong:#94a3b8;
      --shadow:0 10px 30px -14px rgba(2,6,23,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:grid; place-items:center; min-height:100vh;
    }
    header{
      width:100%; max-width:1600px;
      position:sticky; top:0; z-index:4;
      background:linear-gradient(180deg,#fff, #fff 70%, rgba(255,255,255,.6));
      border-bottom:1px solid var(--grid); padding:18px 16px;
    }
    .title{margin:0; text-align:center; color:var(--pri); font-weight:800; letter-spacing:.4px}
    .title .l1{font-size:26px; text-transform:uppercase}
    .title .l2{font-size:13px; color:#334155; margin-top:6px; font-weight:600}
    .shell{
      width:min(1600px, 100vw - 24px);
      margin:16px auto;
      display:grid; grid-template-columns: 420px 1fr; gap:16px;
    }
    .card{
      background:var(--card); border:1px solid var(--grid); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px;
    }
    .section{margin-bottom:14px}
    .section-title{
      display:flex; align-items:center; gap:8px;
      font-weight:800; color:#0b1437; margin:0 0 8px 0; font-size:14px;
    }
    .section-title .tag{font-size:11px; background:#e2e8f0; color:#334155; border-radius:999px; padding:2px 8px}
    label{font-size:12px; color:var(--muted); display:block; margin:4px 0}
    input,select,button,textarea{
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:10px;
      font-size:14px; background:#fff;
    }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .full{grid-column:1/-1}
    .btn{background:var(--pri); color:#fff; border:none; cursor:pointer; font-weight:700}
    .btn.secondary{background:#64748b}
    .btn.ghost{background:#eef2ff; color:#1e40af}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{font-size:12px; margin-top:6px}
    .status.ok{Color:var(--ok)} .status.err{color:var(--err)}
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:sticky; top:calc(64px + 16px); z-index:3;
    }
    .summary{font-size:13px; color:#1f2937}
    .toolbar-actions{display:flex; gap:8px}
    .results-grid{
      display:grid;
      grid-template-columns:minmax(440px,48%) 1fr;
      gap:12px;
      align-items:start;
    }
    .scroll{overflow:auto; border:1px solid var(--grid); border-radius:12px; background:#fff}
    table{width:max-content; border-collapse:separate; border-spacing:0; font-size:12px; white-space:nowrap}
    thead th, tbody td{
      padding:8px 12px; text-align:center; vertical-align:middle;
      border-right:1.5px solid var(--grid-strong); border-bottom:1.5px solid var(--grid-strong);
    }
    thead th:first-child, tbody td:first-child{border-left:1.5px solid var(--grid-strong)}
    thead th{
      position:sticky; top:0; z-index:2; background:#f1f5f9; border-bottom-color:#64748b;
      font-weight:800;
    }
    thead th:first-child{left:0; z-index:4}
    tbody td:first-child{position:sticky; left:0; background:#fff; z-index:3; text-align:left}
    .dt{display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end; position:relative; z-index:30;}
    .dt input[type="datetime-local"]{
      height:44px; background:#f8fafc; border:1.5px solid var(--grid-strong); font-weight:600; letter-spacing:.2px;
      padding-right:36px; position:relative; z-index:31;
    }
    .agg-table{width:100%;border-collapse:collapse;margin-top:8px}
    .agg-table th,.agg-table td{padding:7px 8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:13px}
    .agg-table thead th{background:#f8fafc;font-weight:800}
    @media (max-width:1100px){
      .shell{grid-template-columns:1fr}
      .toolbar{top:calc(64px + 8px)}
      .results-grid{grid-template-columns:1fr}
    }

    /* small tweaks cho khu vực bộ lọc tỉnh */
    .province-filters { margin:8px 0 12px 0; max-height:220px; overflow:auto; border:1px solid #eef2f6; padding:6px; border-radius:8px; background:#fff; display:flex; flex-direction:column; gap:6px }
    .province-filters label{display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:13px;border-radius:6px}
    .province-filters label:hover{background:#f8fafc}
    .province-filters input[type=checkbox]{width:16px;height:16px;margin:0}
    .prov-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .prov-actions .left{display:flex;align-items:center;gap:8px}
    .prov-actions .right{display:flex;align-items:center}
  </style>

  <!-- ====== Styles riêng cho app mưa (bảng + chart) ====== -->
  <style>
  body{margin:0;background:#f1f5f9;font-family:Inter,system-ui,Avenir,Helvetica,Arial,sans-serif}
  .container{max-width:1280px;margin:18px auto;padding:12px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .header h2{margin:0;font-size:20px;font-weight:800;color:#0f172a}
  .header .total{font-weight:900;color:#c1121f}
  .toolbar{display:grid;grid-template-columns:200px 200px 220px 140px 1fr;gap:10px;align-items:end;margin-bottom:10px}
  .toolbar label{font-size:12px;color:#475569;display:block;margin-bottom:4px}
  .toolbar input,.toolbar select,.toolbar button{width:100%;padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
  .toolbar button{cursor:pointer;font-weight:700;border:none;background:#2563eb;color:#fff}
  .toolbar button:disabled{opacity:.6;cursor:not-allowed}
  .layout{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:start}
  .card{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:10px;box-shadow:0 6px 18px rgba(0,0,0,.04)}
  .card h3{margin:6px 0 10px;font-size:16px;font-weight:800;color:#0f172a}
  .right-pane{position:sticky;top:12px}
  .table-wrapper{width:100%;overflow:auto;border-radius:8px}
  .rain-table{border-collapse:separate;border-spacing:0;width:100%;min-width:760px}
  .rain-table th,.rain-table td{border-bottom:1px solid #eef2f6;padding:7px 8px;text-align:center;white-space:nowrap;font-size:13px}
  .rain-table thead th{position:sticky;top:0;background:#f8fafc;z-index:1}
  .rain-table tbody td.time,.rain-table tfoot td.time{text-align:left;font-weight:700;color:#0f172a;position:sticky;left:0;background:#fff}
  .rain-table tbody tr:nth-child(odd) td{background:#fcfcfd}
  .rain-table tfoot td{font-weight:900;color:#c1121f;background:#fff5f5}
  .mm-black{color:#111827;font-weight:700}.mm-green{color:#16a34a;font-weight:800}.mm-purple{color:#7c3aed;font-weight:800}.mm-red{color:#dc2626;font-weight:900}
  @media (max-width:1100px){.layout{grid-template-columns:1fr}.right-pane{position:static}}
  </style>

  <!-- XLSX reader -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- giữ override toolbar không sticky như anh yêu cầu trước đó -->
  <style>
  .card.toolbar {
    position: static !important;
    top: auto !important;
    z-index: auto !important;
  }
  </style>
</head>
<body>
<header>
  <h1 class="title">
    <div class="l1">ĐÀI KTTV TRUNG BỘ - LƯỢNG MƯA CÁC TRẠM TỰ ĐỘNG</div>
    <div class="l2">Phục vụ công tác phòng chống thiên tai</div>
  </h1>
</header>

<div class="shell">
  <!-- ===== SIDEBAR ===== -->
  <aside class="card">
    <!-- Nguồn dữ liệu -->
    <div class="section">
      <h3 class="section-title">Nguồn dữ liệu <span class="tag">Excel + API</span></h3>
      <div class="row">
        <button id="btnAutoXlsx" class="btn">Tải tự động</button>
        <input type="file" id="fileXlsx" accept=".xlsx" />
      </div>
      <div id="xlsxStatus" class="status">Chưa tải file Excel.</div>
      <div class="status" style="color:var(--muted)">
        Đặt <b>thamso_khaithac.xlsx</b> vào thư mục <b>public/</b> của dự án; giữ nguyên các cột:
        <code>matram, tentram, matinh, Tab, sophut, tinhtong</code>.
      </div>
      <label class="full" style="margin-top:8px">Passcode (nếu API yêu cầu)</label>
      <input id="passcode" type="text" placeholder="để trống nếu không cần">
    </div>

    <hr style="border:none;border-top:1px solid var(--grid); margin:10px 0">

    <!-- Chọn trạm & thời gian -->
    <div class="section">
      <h3 class="section-title">Chọn trạm & thời gian</h3>

      <!-- ====== NEW: Province filters ====== -->
      <div style="font-size:12px;color:#475569;margin-bottom:6px">Lọc theo tỉnh/thành</div>
      <div class="prov-actions">
        <div class="left">
          <label style="display:flex;align-items:center;gap:8px;margin:0">
            <input type="checkbox" id="chkSelectAllProv"> <span style="font-weight:700;margin-left:6px">Chọn tất cả tỉnh</span>
          </label>
        </div>
        <div class="right">
          <button id="btnClearProv" class="btn ghost" style="width:90px;padding:6px">Bỏ chọn</button>
        </div>
      </div>
      <div id="provinceHolder" class="province-filters" aria-live="polite">
        <!-- checkboxes tỉnh sẽ được tạo động ở đây -->
        <div style="color:#94a3b8;font-size:13px">Chưa nạp file Excel.</div>
      </div>

      <label style="margin-top:8px">Chọn các trạm (Giữ Ctrl/Shift để chọn nhiều)</label>
      <select id="multiSelect" multiple size="10" style="height:240px"></select>
      <div id="provStatus" class="status" style="color:var(--muted)">Mặc định chọn tất cả trạm hiển thị. Chọn nhiều trạm: bảng sẽ có thanh kéo ngang.</div>

      <div class="dt" style="margin-top:10px">
        <div>
          <label>Bắt đầu</label>
          <input type="datetime-local" id="startDt">
        </div>
        <div>
          <label>Kết thúc</label>
          <input type="datetime-local" id="endDt">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Chu kỳ (sophut)</label>
          <input type="number" id="sophut" min="1" step="1" value="60">
        </div>
        <div>
          <label>ten_table (mặc định lấy theo Excel)</label>
          <input id="tenTable" placeholder="để trống để lấy theo Excel">
        </div>
      </div>

      <label style="margin-top:8px"><input type="checkbox" id="tinhtong" checked> Tính tổng theo ngày (tinhtong=1)</label>
    </div>

    <!-- Thao tác -->
    <div class="section">
      <h3 class="section-title">Thao tác</h3>
      <div class="row">
        <button id="btnFetch" class="btn">Lấy dữ liệu</button>
        <button id="btnClear" class="btn secondary">Xoá kết quả</button>
      </div>
    </div>

    <!-- Thêm cấu phần tuỳ chọn tổng hợp (nhỏ, không thay đổi giao diện) -->
    <div class="section">
      <h3 class="section-title">Tùy chọn tổng hợp <span class="tag">Aggregates</span></h3>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="showAggregates" checked> Hiển thị bảng tổng hợp (1h/3h/6h & 6h-blocks)</label>
      <div class="status" style="color:var(--muted); font-size:12px">Bảng sẽ tính Max sliding-window trong khoảng thời gian đang chọn; 6h-blocks là các khung 6h không chồng chéo bắt đầu từ startDt.</div>
      <div style="margin-top:8px">
        <button id="btnExportAgg" class="btn ghost" disabled>Tải CSV tổng hợp</button>
      </div>
    </div>

  </aside>

  <!-- ===== MAIN ===== -->
  <main style="display:grid; gap:16px;">
    <div class="card toolbar">
      <div class="summary" id="summary">Chưa có dữ liệu. Hãy chọn trạm & thời gian rồi bấm “Lấy dữ liệu”.</div>
      <div class="toolbar-actions">
        <button id="btnExport" class="btn ghost" disabled>Tải CSV</button>
        <button id="btnExportXlsx" class="btn ghost" disabled>Tải Excel (.xlsx)</button>
      </div>
    </div>

    <!-- KẾT QUẢ: bảng trái + đồ thị phải -->
    <div class="card" style="padding:12px">
      <div class="results-grid">
        <div class="scroll" id="tableBox" style="padding:0">
          <table id="dataTable" class="rain-table">
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
            <tfoot id="tfoot"></tfoot>
          </table>
        </div>

        <!-- Chart box + agregates (giữ nguyên giao diện, thêm phần tổng hợp trong box này) -->
        <div id="chartBox" class="card" style="min-height:360px; padding:12px;">

          <!-- small adjustment control: can chỉnh margin-left (px) của title/time line -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <label style="font-size:12px;color:#475569;margin:0 4px 0 0">Điều chỉnh canh lề (px)</label>
            <input id="adjustPixels" type="range" min="-100" max="100" value="-12" style="width:220px">
            <input id="adjustPixelsNumber" type="number" value="-12" style="width:72px;padding:6px;border:1px solid #e2e8f0;border-radius:8px">
            <button id="resetAdjust" class="btn ghost" style="width:90px;padding:6px">Reset</button>
          </div>

          <div id="chartInner" style="font-size:12px;color:#64748b">
            Chưa có dữ liệu để vẽ đồ thị.
          </div>

          <!-- AGGREGATES AREA: hiển thị bảng tổng hợp  va 6h-blocks -->
          <div id="aggArea" style="margin-top:12px; display:none">
            <div style="margin-bottom:8px; font-weight:800; color:#0f172a">BẢNG MƯA LỚN NHẤT THEO TỪNG THỜI ĐOẠN</div>
            <div id="aggSummaryHolder"></div>

            <div style="margin-top:12px; font-weight:800; color:#0f172a">BẢNG TỔNG LƯỢNG MƯA THEO THỜI ĐOẠN 6 GIỜ</div>
            <div id="matrixHolder" style="margin-top:6px; overflow:auto"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* ===== CONFIG (Netlify Proxy) ===== */
const API_PROXY = "/.netlify/functions/proxy";
const DEFAULT_XLSX_PATH = "/thamso_khaithac.xlsx";
const EXCEL_SHEET = "KhaibaoQuangtri";

/* ===== UTIL ===== */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,"0");
const toLocalDatetimeValue = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
const quote = s => `'${s}'`;
function buildProxyUrl(p){ return `${API_PROXY}?` + new URLSearchParams(p).toString(); }

function safeNum(v){ const n=Number(String(v??'').toString().replace(',','.')); return isFinite(n)?n:NaN; }

/* CSV/XLSX Export helpers (giữ nguyên) */
function toCSV(rows){
  if(!rows?.length) return "";
  const cols = Object.keys(rows[0]);
  const esc = v => `"${String(v??"").replace(/"/g,'""')}"`;
  const head = cols.map(esc).join(",");
  const body = rows.map(r => cols.map(c => esc(r[c])).join(",")).join("\n");
  return head+"\n"+body;
}
function downloadCSV(rows, filename='rain_ketqua.csv'){
  const csv = toCSV(rows);
  const bom = '\uFEFF';
  const blob = new Blob([bom, csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function downloadXLSX(rows){
  if (!rows?.length) return;
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'DuLieu');
  XLSX.writeFile(wb, 'rain_ketqua.xlsx');
}

/* Fetch JSON (fallback AllOrigins nếu CORS lỗi) */
async function fetchJSON(url){
  async function doFetch(u){
    const res = await fetch(u, { credentials:'include' });
    const text = await res.text();
    if (!res.ok) throw new Error(text || `HTTP ${res.status}`);
    try { return JSON.parse(text); }
    catch(e){ throw new Error(text.slice(0,180)); }
  }
  try { return await doFetch(url); }
  catch(e){
    const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
    return await doFetch(proxy);
  }
}

/* ===== READ EXCEL (STATIONS) ===== */
let stations=[];
function normalizeRow(r){
  const pick=(a,b)=> (a!==undefined && a!=='')?a:b;
  return {
    matram:String(pick(r.matram,r.MATRAM)||'').trim(),
    tentram:String(pick(r.tentram,r.TENTRAM)||'').trim(),
    matinh:String(pick(r.matinh,r.MATINH)||'').trim(),
    Tab:String(pick(r.Tab,r.tab)||'').trim(),
    sophut:Number(pick(r.sophut,r.SOPHUT)||60)||60,
    tinhtong:Number(pick(r.tinhtong,r.TINHTONG)||0)||0
  };
}
function loadFromWorkbook(wb){
  const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
  const arr = XLSX.utils.sheet_to_json(ws,{defval:''});
  stations = arr.map(normalizeRow).filter(r=>r.matram);
  if (!stations.length) throw new Error('Không đọc được danh sách trạm từ Excel.');
  $('#xlsxStatus').className='status ok';
  $('#xlsxStatus').textContent=`Đã nạp ${stations.length} trạm.`;
  buildProvinceFilters();    // <-- build filters from matinh
  fillStationSelects();      // <-- populate multiSelect with current province filter
}
async function tryAutoLoadExcel(){
  $('#xlsxStatus').textContent='Đang tải thamso_khaithac.xlsx…';
  const res = await fetch(DEFAULT_XLSX_PATH);
  if (!res.ok) throw new Error('Không thấy /thamso_khaithac.xlsx (đặt file vào thư mục public/)');
  const ab = await res.arrayBuffer();
  const wb = XLSX.read(ab,{type:'array'});
  loadFromWorkbook(wb);
}

/* ===== UI: stations & province filters ====== */

/* Get selected provinces from checkboxes */
function getSelectedProvinces(){
  const holder = document.getElementById('provinceHolder');
  if(!holder) return null;
  const checked = Array.from(holder.querySelectorAll('input[type=checkbox].prov-chk:checked')).map(i=>i.value);
  return checked; // array of values (matinh or label)
}

/* Build list of unique provinces and render checkboxes */
function buildProvinceFilters(){
  const holder = document.getElementById('provinceHolder');
  if(!holder) return;
  holder.innerHTML = '';
  // derive unique provinces: use stations[].matinh if available, else fallback to empty string
  const setProv = new Map(); // key -> display label (prefers human readable)
  stations.forEach(s=>{
    const key = (s.matinh ?? '').toString().trim();
    const label = key || '(không rõ)';
    if(!setProv.has(key)) setProv.set(key, label);
  });
  // Sort alphabetically by label
  const provs = Array.from(setProv.entries()).sort((a,b)=> String(a[1]).localeCompare(String(b[1])));
  if(!provs.length){
    holder.innerHTML = '<div style="color:#94a3b8;font-size:13px">Không tìm thấy trường tỉnh (matinh) trong Excel.</div>';
    return;
  }
  // Create checkboxes (vertical stack, left aligned)
  provs.forEach(([key,label])=>{
    const id = 'prov_' + btoa(unescape(encodeURIComponent(key||'empty'))).replace(/=/g,'');
    const lab = document.createElement('label');
    lab.className = 'prov-item';
    // show label text left, checkbox at start
    lab.innerHTML = `<input class="prov-chk" type="checkbox" value="${key}" id="${id}" checked> <span style="margin-left:6px">${label || '(không rõ)'}</span>`;
    holder.appendChild(lab);
  });

  // hook events: when any prov checkbox changes -> update multiSelect
  holder.querySelectorAll('input.prov-chk').forEach(el=>{
    el.addEventListener('change', ()=>{
      // sync selectAll checkbox state
      const all = holder.querySelectorAll('input.prov-chk');
      const checked = holder.querySelectorAll('input.prov-chk:checked');
      $('#chkSelectAllProv').checked = (all.length === checked.length);
      updateMultiSelectByProvince();
    });
  });

  // set SelectAll default checked
  $('#chkSelectAllProv').checked = true;
  // hook selectAll and clear button
  $('#chkSelectAllProv').addEventListener('change', (e)=>{
    const val = !!e.target.checked;
    holder.querySelectorAll('input.prov-chk').forEach(cb=> cb.checked = val);
    updateMultiSelectByProvince();
  });
  $('#btnClearProv').addEventListener('click', ()=>{
    holder.querySelectorAll('input.prov-chk').forEach(cb=> cb.checked = false);
    $('#chkSelectAllProv').checked = false;
    updateMultiSelectByProvince();
  });

  // initial update
  updateMultiSelectByProvince();
}

/* Fill multiSelect with stations that match currently selected provinces */
function fillStationSelects(){
  const box = $('#multiSelect');
  box.innerHTML = '';
  // get selected provinces
  const selProv = getSelectedProvinces(); // array or null
  // filter stations: if selProv is null (no filters built) -> show all
  const filtered = (Array.isArray(selProv) && selProv.length>0)
    ? stations.filter(s=> selProv.includes((s.matinh||'').toString()))
    : stations.slice(); // copy
  // populate
  filtered.forEach((r,i)=>{
    const o = document.createElement('option');
    // store original station index in data-idx to allow mapping
    o.value = stations.indexOf(r); // value = index in original stations array
    o.textContent = (r.tentram||'(không tên)').trim();
    box.appendChild(o);
  });
  // default selection: select all displayed options
  for(let i=0;i<box.options.length;i++){ box.options[i].selected = true; }
  // update status text
  $('#provStatus').textContent = `Hiển thị ${filtered.length} trạm theo bộ lọc tỉnh.`;
}

/* Called when province checkboxes change */
function updateMultiSelectByProvince(){
  // repopulate multiSelect based on selected provinces
  fillStationSelects();
}

/* ====== MÀU THEO NGƯỠNG + HÀNG TỔNG ====== */
function mmClass(val){
  const v = Number(String(val ?? "").toString().replace(",", "."));
  if (!isFinite(v)) return "";
  if (v < 10) return "mm-black";
  if (v <= 25) return "mm-green";
  if (v <= 50) return "mm-purple";
  return "mm-red";
}

/* ===== Remaining code (renderTable, renderChart, aggregates, etc.) =====
   Em giữ nguyên các hàm cũ như anh đã có (renderTable, renderChart, buildSeriesFromRows, ...).
   — chỉ cần đảm bảo các hàm này vẫn sử dụng multiSelect.options[].value (index vào stations)
   Khi lấy danh sách indices để fetch dữ liệu, dùng:
     const indices = Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
*/

/* --- renderTable --- */
function renderTable(rows){
  const thead=$('#thead'), tbody=$('#tbody'), tfoot=$('#tfoot');
  thead.innerHTML=''; tbody.innerHTML=''; tfoot.innerHTML='';

  if(!Array.isArray(rows)||!rows.length){
    thead.innerHTML='<th>(trống)</th>';
    $('#summary').textContent='Không có dữ liệu để hiển thị.';
    $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true;
    renderChart([]);  // dọn chart
    // hide aggregates area
    $('#aggArea').style.display = 'none';
    $('#btnExportAgg').disabled = true;
    return;
  }

  const cols = Object.keys(rows[0]);
  const timeCol =
    cols.find(c => c.toLowerCase().includes('thoi') && c.toLowerCase().includes('gian')) ||
    cols.find(c => /time|date|ngay/i.test(c)) ||
    cols[0];

  const stationCols = cols.filter(c => c !== timeCol);
  const orderedCols = [timeCol, ...stationCols];

  thead.innerHTML = orderedCols.map(c => `<th>${c}</th>`).join('');

  const totals = Object.fromEntries(stationCols.map(c => [c, 0]));
  const frag = document.createDocumentFragment();

  for (const r of rows) {
    const tr = document.createElement('tr');

    const tdTime = document.createElement('td');
    tdTime.textContent = r[timeCol] ?? '';
    tr.appendChild(tdTime);

    for (const c of stationCols) {
      const raw = r[c];
      const num = Number(String(raw ?? '').toString().replace(',', '.'));
      if (isFinite(num)) totals[c] += num;

      const td = document.createElement('td');
      td.textContent = (raw==='' || raw==null) ? '' : (isFinite(num) ? num.toFixed(1) : raw);
      td.className = mmClass(num);
      tr.appendChild(td);
    }

    frag.appendChild(tr);
  }
  tbody.appendChild(frag);

  const trow = document.createElement('tr');
  const first = document.createElement('td');
  first.className = 'time';
  first.innerHTML = '<b>Tổng (mm)</b>';
  trow.appendChild(first);

  for (const c of stationCols) {
    const td = document.createElement('td');
    td.style.fontWeight = '900';
    td.style.color = '#c1121f';
    td.textContent = totals[c] ? totals[c].toFixed(1) : '0.0';
    trow.appendChild(td);
  }
  tfoot.appendChild(trow);

  $('#summary').textContent = `Hiển thị ${rows.length} mốc thời gian — ${stationCols.length} trạm.`;
  $('#btnExport').disabled = false;
  $('#btnExportXlsx').disabled = false;
  window.__lastRows = rows;

  renderChart(rows);
}

/* --- pivot keys and helpers --- */
function pickField(row, keys){ for(const k of keys){ if(row[k]!==undefined && row[k]!==null && row[k]!=='' ) return row[k]; } }
const TIME_KEYS=['thoigian','Thoigian','thoigian_SL','Thoigian_SL','ThoiGian','ThoiGian_SL','time','datetime','date','Ngay','NgayGio','ngaygio'];
const VALUE_KEYS=['solieu','SoLieu','Solieu','GiaTri','giatri','mucnuoc','MucNuoc','value','LuongMua','luongmua','Mua'];
const normTime=t=> (t==null?'':String(t).trim().replace('T',' '));

/* --- date helpers --- */
function pad2(n){return String(n).padStart(2,'0')}
function toLocalDT(d){return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`} 
function fiveDaysAgoMidnight(){ const n=new Date(); n.setDate(n.getDate()-5); n.setHours(0,0,0,0); return n; }
function setDateLimits(){
  const now=new Date();
  const startEl = $('#startDt');
  const endEl   = $('#endDt');

  const minStart = fiveDaysAgoMidnight();
  startEl.min = toLocalDT(minStart);
  startEl.max = toLocalDT(now);

  if (!startEl.value || new Date(startEl.value) < minStart) startEl.value = toLocalDT(minStart);
  if (new Date(startEl.value) > now) startEl.value = toLocalDT(now);

  endEl.min = startEl.value;
  endEl.max = toLocalDT(now);

  if (!endEl.value || new Date(endEl.value) < new Date(startEl.value)) endEl.value = toLocalDT(now);
  if (new Date(endEl.value) > now) endEl.value = toLocalDT(now);
}

/* --- parse time --- */
function parseTimeString(t){
  if(!t && t!==0) return null;
  if (t instanceof Date) return t;
  let s = String(t).trim();
  if (!s) return null;
  try {
    if (s.includes('/') && /^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)) {
      const [d,m,y, ...rest] = s.replace(',', '').split(/[\/\s:]+/);
      const timePart = rest.length? (' ' + rest.slice(0,3).map(x=>x.padStart(2,'0')).join(':')): '';
      s = `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}${timePart}`;
    }
    s = s.replace('T',' ').replace(/\.\d+$/,'');
    const dtParts = s.split(' ');
    if (dtParts.length === 2 && dtParts[1].split(':').length === 2) s = s + ':00';
    const dObj = new Date(s);
    if (!isNaN(dObj.getTime())) return dObj;
  } catch(e){ }
  const d2 = new Date(Date.parse(s));
  return isNaN(d2.getTime())? null : d2;
}

/* --- renderChart (giữ nguyên logic đã có) --- */
function renderChart(rows){
  const host = $('#chartInner');
  host.innerHTML = '';

  if (!Array.isArray(rows) || !rows.length){
    const div=document.createElement('div');
    div.style.cssText='font-size:12px;color:#64748b';
    div.textContent='Chưa có dữ liệu để vẽ đồ thị.';
    host.appendChild(div);
    return;
  }

  const cols = Object.keys(rows[0]);
  const timeCol =
    cols.find(c => c.toLowerCase().includes('thoi') && c.toLowerCase().includes('gian')) ||
    cols.find(c => /time|date|ngay/i.test(c)) ||
    cols[0];
  const stationCols = cols.filter(c => c !== timeCol);
  if (!stationCols.length){
    const div=document.createElement('div');
    div.style.cssText='font-size:12px;color:#64748b';
    div.textContent='Không tìm thấy cột trạm để tính tổng.';
    host.appendChild(div);
    return;
  }

  const totals = stationCols.map(name=>{
    let sum = 0;
    for (const r of rows){
      const v = Number(String(r[name] ?? '').toString().replace(',','.'));
      if (isFinite(v)) sum += v;
    }
    return { name, total: Number(sum.toFixed(1)) };
  });

  const defaultAdjust = -12;
  const ADJUST_PIXELS = (typeof window.__ADJUST_PIXELS === 'number') ? window.__ADJUST_PIXELS : defaultAdjust;
  const BAR_LABEL_FONT_SIZE = 9;

  const title = document.createElement('div');
  title.style.cssText='font-size:13px;color:#1e3a8a;font-weight:700;margin-bottom:6px';
  title.textContent='ĐỒ THỊ TỔNG LƯỢNG MƯA THEO TRẠM(mm).';
  host.appendChild(title);

  const startVal = $('#startDt').value;
  const endVal = $('#endDt').value;
  let range = null;
  if (startVal && endVal){
    const t1 = new Date(startVal);
    const t2 = new Date(endVal);
    const f = d => `${String(d.getHours()).padStart(2,'0')}h${String(d.getMinutes()).padStart(2,'0')} ngày ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const txt = `Thời gian tính từ ${f(t1)} đến ${f(t2)}.`;
    range = document.createElement('div');
    range.style.cssText='font-size:11px;color:#1e3a8a;font-weight:700;margin-bottom:10px';
    range.textContent = txt;
    host.appendChild(range);
  }

  let chartBoxPaddingLeft = 12;
  try {
    const cb = document.getElementById('chartBox');
    if (cb) {
      const cs = getComputedStyle(cb);
      const pl = parseFloat(cs.paddingLeft || '12');
      if (!isNaN(pl)) chartBoxPaddingLeft = pl;
    }
  } catch(e){ }

  const W = Math.max(600, host.clientWidth || 800);
  const H = 260;

  const maxY = Math.max(1, ...totals.map(t => t.total));
  const ticks = 5;
  const tickVals = [];
  for (let i=0;i<=ticks;i++) tickVals.push((maxY / ticks) * i);

  const tmpSvg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  tmpSvg.setAttribute('width','0'); tmpSvg.setAttribute('height','0');
  document.body.appendChild(tmpSvg);
  let maxLabelW = 0;
  tickVals.forEach(v=>{
    const t = document.createElementNS(tmpSvg.namespaceURI,'text');
    t.setAttribute('font-size','11');
    t.textContent = v.toFixed(1);
    tmpSvg.appendChild(t);
    let bbox = { width: String(t.textContent).length * 6 };
    try { bbox = t.getBBox(); } catch(e){ }
    maxLabelW = Math.max(maxLabelW, bbox.width);
    tmpSvg.removeChild(t);
  });
  document.body.removeChild(tmpSvg);

  const m = { l: Math.ceil(maxLabelW + 14), r:16, t:12, b:90 };

  const innerW = W - m.l - m.r;
  const innerH = H - m.t - m.b;
  const y = v => m.t + innerH - (v / maxY) * innerH;

  const n = totals.length;
  const slot = innerW / Math.max(n,1);
  const barW = Math.max(12, Math.min(48, slot * 0.7));
  const x = i => m.l + i*slot + (slot - barW)/2;

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('width','100%');
  svg.setAttribute('height', H);
  svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
  host.appendChild(svg);

  for (let i=0;i<=ticks;i++){
    const v = (maxY / ticks) * i;
    const yy = y(v);
    const line = document.createElementNS(svg.namespaceURI,'line');
    line.setAttribute('x1', m.l);
    line.setAttribute('y1', yy);
    line.setAttribute('x2', W - m.r);
    line.setAttribute('y2', yy);
    line.setAttribute('stroke', '#e2e8f0');
    line.setAttribute('stroke-dasharray', '3 3');
    svg.appendChild(line);

    const t = document.createElementNS(svg.namespaceURI,'text');
    t.setAttribute('x', m.l - 6);
    t.setAttribute('y', yy + 4);
    t.setAttribute('text-anchor','end');
    t.setAttribute('font-size','11');
    t.setAttribute('fill','#334155');
    t.textContent = v.toFixed(1);
    svg.appendChild(t);
  }

  totals.forEach((d, i) => {
    const xx = x(i);
    const yy = y(d.total);
    const h  = (m.t + innerH) - yy;

    const rect = document.createElementNS(svg.namespaceURI,'rect');
    rect.setAttribute('x', xx);
    rect.setAttribute('y', yy);
    rect.setAttribute('width', barW);
    rect.setAttribute('height', Math.max(0, h));
    rect.setAttribute('rx', 4);
    rect.setAttribute('fill', '#2563eb');
    svg.appendChild(rect);

    const label = document.createElementNS(svg.namespaceURI,'text');
    label.setAttribute('x', xx + barW/2);
    label.setAttribute('y', yy - 6);
    label.setAttribute('text-anchor','middle');
    label.setAttribute('font-size', String(BAR_LABEL_FONT_SIZE));
    label.setAttribute('font-weight','500');
    label.setAttribute('fill','#0f172a');
    label.textContent = d.total.toFixed(1);
    svg.appendChild(label);

    const baseY = m.t + innerH + 48;
    const tx = document.createElementNS(svg.namespaceURI,'text');
    tx.setAttribute('x', xx + barW/2);
    tx.setAttribute('y', baseY);
    tx.setAttribute('text-anchor','end');
    tx.setAttribute('font-size','11');
    tx.setAttribute('fill','#334155');
    tx.setAttribute('transform', `rotate(-55 ${xx + barW/2} ${baseY})`);
    tx.textContent = d.name;
    svg.appendChild(tx);
  });

  const axis = document.createElementNS(svg.namespaceURI,'line');
  axis.setAttribute('x1', m.l);
  axis.setAttribute('y1', m.t + innerH);
  axis.setAttribute('x2', W - m.r);
  axis.setAttribute('y2', m.t + innerH);
  axis.setAttribute('stroke', '#cbd5e1');
  svg.appendChild(axis);

  try {
    const cb = document.getElementById('chartBox');
    let cbPL = chartBoxPaddingLeft;
    if (cb) {
      const cs = getComputedStyle(cb);
      const pl = parseFloat(cs.paddingLeft || cbPL);
      if (!isNaN(pl)) cbPL = pl;
    }
    const desiredMargin = Math.max(0, m.l - cbPL + ADJUST_PIXELS);
    if (title) title.style.marginLeft = `${desiredMargin}px`;
    if (range) range.style.marginLeft = `${desiredMargin}px`;
  } catch(e){ }
}

/* --- thêm: buildSeriesFromRows, computeStationAggregates, slidingWindowSums, renderAggregatesTable, render6hMatrix --- */

function buildSeriesFromRows(rows){
  // rows: mảng pivoted: mỗi phần tử { 'thoi gian': '...', 'Tram A': val, 'Tram B': val, ... }
  // trả về map: { 'Tram A': [{t:Date, v:Number}, ...], ... }
  const cols = Object.keys(rows[0] || {});
  const timeCol = cols.find(c => c.toLowerCase().includes('thoi') && c.toLowerCase().includes('gian'))
    || cols.find(c => /time|date|ngay/i.test(c)) || cols[0];

  const seriesMap = {};
  for (const c of cols) if (c !== timeCol) seriesMap[c] = [];

  for (const r of rows){
    const tRaw = r[timeCol];
    const dt = parseTimeString(tRaw) || parseTimeString(normTime(tRaw));
    if (!dt) continue;
    for (const c of cols){
      if (c === timeCol) continue;
      const raw = r[c];
      const v = safeNum(raw);
      if (!isFinite(v)) continue;
      seriesMap[c].push({ t: new Date(dt.getTime()), v: Number(v) });
    }
  }
  // sort each series by time asc
  for (const k of Object.keys(seriesMap)){
    seriesMap[k].sort((a,b)=> a.t - b.t);
  }
  return seriesMap;
}

/**
 * slidingWindowSums:
 * - series: [{t:Date, v:Number}, ...] (sorted ascending)
 * - windowMinutes: số phút của cửa sổ (ví dụ 60, 180, 360)
 * trả về: { maxSum, start: Date, end: Date }
 */
function slidingWindowSums(series, windowMinutes){
  const res = { maxSum: 0, start: null, end: null };
  if (!Array.isArray(series) || series.length === 0) return res;
  const n = series.length;
  let j = 0;
  let running = 0;
  const wms = windowMinutes * 60 * 1000;
  for (let i=0;i<n;i++){
    // ensure j >= i
    if (j < i) { j = i; running = 0; }
    // expand j while time difference <= windowMinutes
    while (j < n && (series[j].t.getTime() - series[i].t.getTime()) <= wms){
      running += Number(series[j].v) || 0;
      j++;
    }
    // running now is sum over [i, j-1] where times within windowMinutes from series[i]
    if (running > res.maxSum){
      res.maxSum = Number(running.toFixed(3));
      res.start = series[i].t;
      res.end = series[Math.max(0, j-1)].t;
    }
    // move i forward: subtract series[i].v from running
    running -= Number(series[i].v) || 0;
  }
  return res;
}

/* computeStationAggregates(series, endDate)
   - series: [{t:Date, v:Number}, ...] sorted asc
   - endDate: Date object (end of requested interval) used to compute "recent3h"
   returns object with fields: total, max1h, max3h, max6h, recent3h
*/
function computeStationAggregates(series, endDate){
  const out = { total: 0, max1h: 0, max3h: 0, max6h: 0, recent3h: 0 };
  if (!Array.isArray(series) || series.length === 0) return out;

  // total
  let tot = 0;
  for (const s of series){ const vv = Number(s.v) || 0; tot += vv; }
  out.total = Number(tot.toFixed(3));

  // sliding windows
  const win1 = slidingWindowSums(series, 60);
  const win3 = slidingWindowSums(series, 180);
  const win6 = slidingWindowSums(series, 360);
  out.max1h = Number((win1.maxSum || 0).toFixed(3));
  out.max3h = Number((win3.maxSum || 0).toFixed(3));
  out.max6h = Number((win6.maxSum || 0).toFixed(3));

  // recent 3h: sum of values where time > (endDate - 3h) and <= endDate
  if (!endDate || !(endDate instanceof Date)) endDate = new Date();
  const from = new Date(endDate.getTime() - 3*60*60*1000);
  let recent = 0;
  for (let i=series.length-1;i>=0;i--){
    const s = series[i];
    if (s.t <= endDate && s.t > from) recent += Number(s.v) || 0;
    if (s.t <= from) break;
  }
  out.recent3h = Number(recent.toFixed(3));
  return out;
}

/* renderAggregatesTable(aggs)
   aggs: { stationName: { total, max1h, max3h, max6h, recent3h }, ... }
*/
function renderAggregatesTable(aggs){
  const holder = $('#aggSummaryHolder');
  holder.innerHTML = '';
  if(!aggs || Object.keys(aggs).length === 0){
    holder.innerHTML = '<div style="color:#64748b">Không có dữ liệu tổng hợp.</div>';
    window.__lastAgg = [];
    $('#btnExportAgg').disabled = true;
    return;
  }

  // build array and sort by total desc
  const arr = Object.keys(aggs).map(k => ({ name: k, ...aggs[k] }));
  arr.sort((a,b) => (b.total || 0) - (a.total || 0));

  // store for export
  window.__lastAgg = arr.map(r => ({
    Tram: r.name,
    Tong_mm: Number((r.total||0).toFixed(3)),
    Max_1h_mm: Number((r.max1h||0).toFixed(3)),
    Max_3h_mm: Number((r.max3h||0).toFixed(3)),
    Max_6h_mm: Number((r.max6h||0).toFixed(3)),
    Tong_3h_gannhat_mm: Number((r.recent3h||0).toFixed(3))
  }));

  // create table
  const table = document.createElement('table');
  table.className = 'agg-table';
  const thead = document.createElement('thead');
  thead.innerHTML = `<tr>
    <th>Trạm</th><th>Tổng (mm)</th><th>Max 1h</th><th>Max 3h</th><th>Max 6h</th><th>Tổng 3h (gần nhất)</th>
  </tr>`;
  table.appendChild(thead);
  const tb = document.createElement('tbody');
  for (const r of arr){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="font-weight:700">${r.name}</td>
      <td>${Number((r.total||0).toFixed(1))}</td>
      <td>${Number((r.max1h||0).toFixed(1))}</td>
      <td>${Number((r.max3h||0).toFixed(1))}</td>
      <td>${Number((r.max6h||0).toFixed(1))}</td>
      <td>${Number((r.recent3h||0).toFixed(1))}</td>`;
    tb.appendChild(tr);
  }
  table.appendChild(tb);
  holder.appendChild(table);
  $('#btnExportAgg').disabled = false;
}

/* render6hMatrix(seriesMap, startDate, endDate)
   - seriesMap: { name: [{t:Date, v:Number}, ...], ... }
   - startDate, endDate: Date objects (use startDate as alignment for 6h blocks)
*/
function render6hMatrix(seriesMap, startDate, endDate){
  const holder = $('#matrixHolder');
  holder.innerHTML = '';
  if (!seriesMap || Object.keys(seriesMap).length === 0){
    holder.innerHTML = '<div style="color:#64748b">Không có dữ liệu để tính ma trận 6h.</div>';
    return;
  }
  if (!(startDate instanceof Date)) startDate = new Date();
  if (!(endDate instanceof Date)) endDate = new Date();

  // normalize start to floor to nearest 6h block relative to startDate's day (blocks: 00-06,06-12,12-18,18-24)
  const s = new Date(startDate.getTime());
  s.setMinutes(0,0,0);
  const h = s.getHours();
  const blockStartHour = Math.floor(h / 6) * 6;
  s.setHours(blockStartHour,0,0,0);
  // build blocks until endDate
  const blocks = [];
  let cur = new Date(s.getTime());
  while (cur.getTime() <= endDate.getTime()){
    const bStart = new Date(cur.getTime());
    const bEnd = new Date(cur.getTime() + 6*60*60*1000);
    blocks.push({ start: bStart, end: bEnd });
    cur = bEnd;
    // safety: avoid infinite loop
    if (blocks.length > 500) break;
  }

  // header row
  const table = document.createElement('table');
  table.className = 'rain-table';
  table.style.minWidth = '720px';
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  trh.innerHTML = `<th>Tên trạm</th>` + blocks.map(b => `<th>${pad(b.start.getHours())}h ${pad(b.start.getDate())}/${pad(b.start.getMonth()+1)}</th>`).join('');
  thead.appendChild(trh);
  table.appendChild(thead);

  // rows: for each station, sum values within each block
  const tbody = document.createElement('tbody');
  for (const name of Object.keys(seriesMap)){
    const series = seriesMap[name] || [];
    const tr = document.createElement('tr');
    const tdName = document.createElement('td');
    tdName.className = 'time';
    tdName.textContent = name;
    tr.appendChild(tdName);

    for (const b of blocks){
      let sum = 0;
      // series is sorted asc -> we can iterate until t >= b.end
      for (let i=0;i<series.length;i++){
        const it = series[i];
        if (it.t >= b.start && it.t < b.end){
          sum += Number(it.v) || 0;
        }
        if (it.t >= b.end) break;
      }
      const td = document.createElement('td');
      td.textContent = Number(sum.toFixed(1));
      td.className = mmClass(sum);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  table.appendChild(tbody);
  holder.appendChild(table);
}

/* ===== MAIN FLOW ===== */
async function init(){
  const now=new Date(), s0=new Date(now); s0.setDate(now.getDate()-2); s0.setHours(0,0,0,0);
  $('#startDt').value=toLocalDT(s0);
  $('#endDt').value=toLocalDT(now);
  setDateLimits();
  $('#startDt').addEventListener('change', setDateLimits);
  $('#endDt').addEventListener('change', setDateLimits);

  // Adjustment control
  window.__ADJUST_PIXELS = -12;
  const adjRange = document.getElementById('adjustPixels');
  const adjNum   = document.getElementById('adjustPixelsNumber');
  const resetBtn = document.getElementById('resetAdjust');
  if (adjRange && adjNum) {
    adjRange.addEventListener('input', (e) => {
      const v = Number(e.target.value) || 0;
      adjNum.value = v;
      window.__ADJUST_PIXELS = v;
      if (window.__lastRows) renderChart(window.__lastRows);
    });
    adjNum.addEventListener('change', (e) => {
      const v = Number(e.target.value) || 0;
      adjRange.value = v;
      window.__ADJUST_PIXELS = v;
      if (window.__lastRows) renderChart(window.__lastRows);
    });
    resetBtn.addEventListener('click', () => {
      window.__ADJUST_PIXELS = -12;
      adjRange.value = -12;
      adjNum.value = -12;
      if (window.__lastRows) renderChart(window.__lastRows);
    });
  }

  $('#btnAutoXlsx').addEventListener('click', async ()=>{
    try{ await tryAutoLoadExcel(); }catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; }
  });
  $('#fileXlsx').addEventListener('change', async ev=>{
    const f=ev.target.files?.[0]; if(!f) return;
    try{ const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); loadFromWorkbook(wb); }
    catch(e){ $('#xlsxStatus').className='status err'; $('#xlsxStatus').textContent=e.message; }
  });

  $('#btnFetch').addEventListener('click', async ()=>{
    if(!stations.length){ alert('Chưa nạp danh sách trạm từ Excel.'); return; }
    const pass=$('#passcode').value.trim();
    let s=new Date($('#startDt').value), e=new Date($('#endDt').value);
    if(!(s.getTime()<e.getTime())){ alert('Khoảng thời gian không hợp lệ.'); return; }

    // Note: multiSelect option values are indices into original stations[]
    const indices=Array.from($('#multiSelect').selectedOptions).map(o=>Number(o.value));
    if(!indices.length){ alert('Hãy chọn ít nhất 1 trạm.'); return; }

    const tinhtong=$('#tinhtong').checked?1:0;

    const fmt=(dt)=>`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:00`;
    const sStr=fmt(s), eStr=fmt(e);

    const datasets={};
    $('#summary').textContent='Đang lấy dữ liệu…';
    await Promise.all(indices.map(async idx=>{
      const r=stations[idx];
      const ten_table=($('#tenTable').value.trim()||r.Tab||'mucnuoc_oday');
      const sophut=Number($('#sophut').value||r.sophut||60)||60;
      const params={ matram:r.matram, ten_table, sophut:String(sophut), tinhtong:String(tinhtong),
                     thoigianbd:quote(sStr), thoigiankt:quote(eStr) };
      if(pass) params.passcode=pass;
      const url=buildProxyUrl(params);
      try{
        const data=await fetchJSON(url);
        datasets[r.tentram||r.matram]=Array.isArray(data)?data:[];
      }catch(e){
        console.warn('Fetch lỗi', r.matram, e);
        datasets[r.tentram||r.matram]=[];
      }
    }));

    // pivot theo thời gian
    const timeIndex=new Map();
    const names=Object.keys(datasets);
    for(const n of names){
      for(const row of (datasets[n]||[])){
        const t=normTime(pickField(row, TIME_KEYS));
        const v=pickField(row, VALUE_KEYS);
        if(!t) continue;
        if(!timeIndex.has(t)) timeIndex.set(t, {"thoi gian": t});
        timeIndex.get(t)[n]=v;
      }
    }
    const rows=Array.from(timeIndex.values())
      .sort((a,b)=>String(a['thoi gian']).localeCompare(String(b['thoi gian'])));
    renderTable(rows);

    // ---- aggregates ----
    if($('#showAggregates').checked){
      const seriesMap = buildSeriesFromRows(rows);
      const aggs = {};
      for(const name of Object.keys(seriesMap)){
        aggs[name] = computeStationAggregates(seriesMap[name], e);
      }
      renderAggregatesTable(aggs);
      render6hMatrix(seriesMap, s, e);
      $('#aggArea').style.display = 'block';
    } else {
      $('#aggArea').style.display = 'none';
      $('#btnExportAgg').disabled = true;
    }
  });

  $('#btnClear').addEventListener('click', ()=>{
    $('#thead').innerHTML=''; $('#tbody').innerHTML='';
    $('#tfoot').innerHTML='';
    $('#summary').textContent='Đã xoá kết quả.';
    $('#btnExport').disabled=true; $('#btnExportXlsx').disabled=true;
    renderChart([]);
    $('#aggArea').style.display = 'none';
    $('#btnExportAgg').disabled = true;
  });

  $('#btnExport').addEventListener('click', ()=> downloadCSV(window.__lastRows||[]));
  $('#btnExportXlsx').addEventListener('click', ()=> downloadXLSX(window.__lastRows||[]));
  $('#btnExportAgg').addEventListener('click', ()=> {
    const rows = window.__lastAgg || [];
    if(rows && rows.length) downloadCSV(rows, 'rain_tonghop.csv');
    else alert('Không có dữ liệu tổng hợp.');
  });

  try{ await tryAutoLoadExcel(); }
  catch(e){ $('#xlsxStatus').className='status'; $('#xlsxStatus').textContent='Không tìm thấy file mặc định. Hãy chọn file .xlsx thủ công.'; }
}
window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
